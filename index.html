import React, { useState, useEffect, useRef } from 'react';
import { Droplets, Sun, Scissors, Shovel, Trophy, Timer, Hand } from 'lucide-react';

// ã‚²ãƒ¼ãƒ å®šæ•°
const TICK_RATE = 800; // 1æ—¥ãŒé€²ã‚€é€Ÿåº¦ (ms)
const MAX_DAYS = 100; // åç©«çµ‚äº†ã¾ã§ã®æ—¥æ•°
const MAX_WATER = 100;
const MAX_FERTILIZER = 100;

// ã‚¹ãƒ†ãƒ¼ã‚¸å®šç¾©
const STAGES = {
  SEED: { name: 'ç¨®ã¾ã', threshold: 0 },
  SPROUT: { name: 'ç™ºèŠ½', threshold: 5 },
  GROWTH: { name: 'æˆé•·æœŸ', threshold: 15 },
  FLOWER: { name: 'é–‹èŠ±', threshold: 35 },
  FRUIT: { name: 'çµå®Ÿ', threshold: 50 },
  HARVEST: { name: 'åç©«æœŸ', threshold: 65 },
};

// å®Ÿãƒ»èŠ±ãŒãªã‚‹ä½ç½®ã®å®šç¾©ï¼ˆæã®å…ˆç«¯åº§æ¨™ã«åˆã‚ã›ã‚‹ï¼‰
// æã®å®šç¾©: start(100, y) -> control(100 + 30*dir, y-10) -> end(100 + 50*dir, y+10)
const SLOT_POSITIONS = [
  { id: 0, x: 50, y: 250, branchId: 1 },  // ä¸‹æ®µå·¦ (100-50, 240+10)
  { id: 1, x: 150, y: 210, branchId: 2 }, // ä¸‹æ®µå³ (100+50, 200+10)
  { id: 2, x: 50, y: 170, branchId: 3 },  // ä¸­æ®µå·¦ (100-50, 160+10)
  { id: 3, x: 150, y: 130, branchId: 4 }, // ä¸­æ®µå³ (100+50, 120+10)
  { id: 4, x: 100, y: 80, branchId: 0 },  // é ‚ç‚¹
];

// æ¤ç‰©æç”»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const TomatoPlantSVG = ({ stage, size, sideShoots, slots, onHarvest }) => {
  // æˆé•·åº¦åˆã„ã«å¿œã˜ãŸã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
  const scale = 0.5 + (size / 100) * 0.5;
  
  // æã®åº§æ¨™å®šç¾©
  const branches = [
    { id: 1, x: 100, y: 240, dir: -1 }, // å·¦
    { id: 2, x: 100, y: 200, dir: 1 },  // å³
    { id: 3, x: 100, y: 160, dir: -1 }, // å·¦
    { id: 4, x: 100, y: 120, dir: 1 },  // å³
  ];

  return (
    <div className="relative w-full h-full flex items-end justify-center pointer-events-none">
      <svg viewBox="0 0 200 300" className="w-full h-full drop-shadow-xl" style={{ overflow: 'visible' }}>
        {/* åœ°é¢/ãƒãƒƒãƒˆ */}
        <path d="M 40 280 L 160 280 L 150 300 L 50 300 Z" fill="#8B4513" />
        <ellipse cx="100" cy="280" rx="60" ry="10" fill="#5D4037" />

        {/* --- æˆé•·æ®µéšã”ã¨ã®æç”» --- */}
        
        {/* ç¨®ã¾ãæœŸ */}
        {stage.name === 'ç¨®ã¾ã' && (
          <circle cx="100" cy="280" r="3" fill="#F4A460" />
        )}

        {/* ç™ºèŠ½æœŸä»¥é™ */}
        {(stage.threshold >= STAGES.SPROUT.threshold) && (
           <g transform={`translate(100, 280) scale(${Math.min(1.2, scale)}) translate(-100, -280)`}>
             <path d="M 100 280 Q 100 260 100 250" stroke="#4CAF50" strokeWidth="4" fill="none" />
             <path d="M 100 250 Q 80 240 80 250 Q 90 260 100 250" fill="#81C784" />
             <path d="M 100 250 Q 120 240 120 250 Q 110 260 100 250" fill="#81C784" />
           </g>
        )}

        {/* æˆé•·æœŸä»¥é™ï¼ˆæœ¬è‘‰ã¨èŒï¼‰ */}
        {(stage.threshold >= STAGES.GROWTH.threshold) && (
          <g transform={`translate(100, 280) scale(${Math.min(1.5, scale)}) translate(-100, -280)`}>
            {/* ãƒ¡ã‚¤ãƒ³èŒ */}
            <path d="M 100 280 C 100 200 95 150 100 80" stroke="#388E3C" strokeWidth="6" fill="none" strokeLinecap="round" />
            
            {/* æã¨è‘‰ */}
            {branches.map((b, i) => (
              <g key={b.id}>
                {/* æï¼šå…ˆç«¯ãŒ (b.x + 50*dir, b.y + 10) ã«ãªã‚‹ã‚ˆã†ã«æç”» */}
                <path 
                  d={`M ${b.x} ${b.y} Q ${b.x + (30 * b.dir)} ${b.y - 10} ${b.x + (50 * b.dir)} ${b.y + 10}`} 
                  stroke="#4CAF50" strokeWidth="3" fill="none" 
                />
                {/* è‘‰ï¼šæã®å…ˆç«¯ã«ã¤ã‘ã‚‹ */}
                <path 
                  d={`M ${b.x + (50 * b.dir)} ${b.y + 10} Q ${b.x + (70 * b.dir)} ${b.y} ${b.x + (50 * b.dir)} ${b.y + 20} Z`} 
                  fill="#4CAF50" 
                />
                
                {/* ã‚ãèŠ½ï¼ˆæ‘˜èŠ¯å¯¾è±¡ï¼‰ */}
                {sideShoots > i && (
                  <g className="animate-pulse origin-bottom">
                     <path 
                       d={`M ${b.x} ${b.y} Q ${b.x + (15 * b.dir)} ${b.y - 20} ${b.x + (20 * b.dir)} ${b.y - 30}`} 
                       stroke="#8BC34A" strokeWidth="3" fill="none" 
                     />
                     <path 
                       d={`M ${b.x + (20 * b.dir)} ${b.y - 30} Q ${b.x + (25 * b.dir)} ${b.y - 40} ${b.x + (15 * b.dir)} ${b.y - 35} Z`} 
                       fill="#8BC34A" 
                     />
                     <circle cx={b.x + (10 * b.dir)} cy={b.y - 15} r="2" fill="red" className="animate-ping" opacity="0.5"/>
                  </g>
                )}
              </g>
            ))}
            
            {/* èŠ±ã®æç”»ï¼ˆå®Ÿã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */}
            {slots.map((slot, idx) => {
              if (slot.state === 'flower') {
                return (
                  <g key={`flower-${idx}`} transform={`translate(${slot.x}, ${slot.y})`}>
                    <circle r="6" fill="#FFEB3B" />
                    <circle r="2" fill="#FFA000" />
                    {[0, 60, 120, 180, 240, 300].map(deg => (
                      <ellipse key={deg} cx="0" cy="-6" rx="2" ry="5" fill="#FFEB3B" transform={`rotate(${deg})`} />
                    ))}
                  </g>
                );
              }
              if (slot.state === 'fruit') {
                return (
                   <g key={`stem-${idx}`} transform={`translate(${slot.x}, ${slot.y})`}>
                      <path d="M 0 0 L 0 -5" stroke="#388E3C" strokeWidth="2" />
                   </g>
                );
              }
              return null;
            })}
          </g>
        )}
      </svg>
      
      {/* å®Ÿï¼ˆReactè¦ç´ ã¨ã—ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã—ã¦ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ï¼‰ */}
      {(stage.threshold >= STAGES.FLOWER.threshold) && (
        <div className="absolute inset-0 pointer-events-none" style={{ 
          transform: `translateY(10px) scale(${Math.min(1.5, scale)})`, 
          transformOrigin: 'bottom center' 
        }}>
          {slots.map((slot) => {
            if (slot.state !== 'fruit') return null;

            const isHarvestable = slot.progress >= 90;
            const isRipe = slot.progress >= 100;
            
            // ã‚µã‚¤ã‚ºè¨ˆç®—
            const maxPotentialSize = 50 + (slot.quality / 100) * 40;
            const sizePx = 20 + (slot.progress / 100) * (maxPotentialSize - 20);

            return (
              <div key={slot.id} className="absolute" style={{ 
                  left: `${slot.x}px`, 
                  top: `${slot.y}px`,
                  transform: 'translate(-50%, -50%)',
                  zIndex: 10
              }}>
                {/* åç©«ãƒ’ãƒ³ãƒˆï¼ˆå®Œç†Ÿæ™‚ã®ã¿è¡¨ç¤ºï¼‰ */}
                {isHarvestable && (
                  <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 flex flex-col items-center animate-bounce z-20 pointer-events-none whitespace-nowrap">
                    <Hand size={24} className="text-white fill-orange-500 drop-shadow-md rotate-12" />
                    <span className="text-[10px] font-bold text-white bg-black/60 px-1.5 py-0.5 rounded backdrop-blur-sm mt-0.5">Click!</span>
                  </div>
                )}

                <button
                  onClick={(e) => { 
                    e.stopPropagation(); 
                    onHarvest(slot.id); 
                  }}
                  className={`relative rounded-full shadow-lg transition-all duration-300 pointer-events-auto flex items-center justify-center cursor-pointer hover:scale-105 active:scale-95`}
                  style={{ 
                    width: `${sizePx}px`, 
                    height: `${sizePx}px`,
                    // èµ¤ããªã‚‹ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    backgroundColor: isRipe 
                      ? `rgb(230, 40, 40)` 
                      : `rgb(${120 + slot.progress}, ${200 - slot.progress}, ${100 - slot.progress/2})`,
                    border: '1px solid rgba(0,0,0,0.1)',
                  }}
                >
                  {/* ãƒ˜ã‚¿ */}
                  <div className="absolute -top-1 w-2/3 h-1/3 bg-green-700 rounded-full" 
                       style={{clipPath: 'polygon(50% 0%, 20% 100%, 80% 100%)'}}></div>
                  <div className="absolute -top-1 w-full h-1/3 bg-green-700" 
                       style={{clipPath: 'polygon(50% 50%, 0% 0%, 100% 0%)', transform: 'rotate(180deg)'}}></div>

                  {/* ãƒ„ãƒ¤ */}
                  <div className="absolute top-1/4 left-1/4 w-1/4 h-1/4 bg-white rounded-full opacity-40"></div>
                  
                  {/* å®Œç†Ÿæ™‚ã®ã‚­ãƒ©ã‚­ãƒ© */}
                  {isRipe && (
                    <div className="absolute -right-1 -top-1 text-xs animate-bounce">âœ¨</div>
                  )}
                </button>
              </div>
            )
          })}
        </div>
      )}
    </div>
  );
};

export default function App() {
  const [gameState, setGameState] = useState('start'); 
  const [day, setDay] = useState(0);
  const [score, setScore] = useState(0);
  const [harvestedTomatoes, setHarvestedTomatoes] = useState([]);
  
  const [stats, setStats] = useState({
    water: 50,
    fertilizer: 50,
    health: 100,
    size: 0,
    sideShoots: 0,
    slots: SLOT_POSITIONS.map(p => ({ ...p, state: 'empty', progress: 0, quality: 50 }))
  });

  const [message, setMessage] = useState('ãƒˆãƒãƒˆæ ½åŸ¹ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼');
  const [weather, setWeather] = useState('sunny'); 
  const timerRef = useRef(null);

  // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
  useEffect(() => {
    if (gameState === 'playing') {
      timerRef.current = setInterval(() => {
        advanceDay();
      }, TICK_RATE);
    }
    return () => clearInterval(timerRef.current);
  }, [gameState, stats, day]);

  // å¤©æ°—ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  useEffect(() => {
    if (gameState === 'playing') {
      const rand = Math.random();
      if (rand < 0.6) setWeather('sunny');
      else if (rand < 0.8) setWeather('cloudy');
      else setWeather('rainy');
    }
  }, [day]);

  // å¤©æ°—ã«å¿œã˜ãŸèƒŒæ™¯ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å–å¾—
  const getWeatherBackground = () => {
    switch(weather) {
      case 'rainy':
        return 'bg-gradient-to-b from-slate-700 via-slate-600 to-slate-800 border-slate-600';
      case 'cloudy':
        return 'bg-gradient-to-b from-gray-400 via-gray-300 to-gray-200 border-gray-400';
      case 'sunny':
      default:
        return 'bg-gradient-to-b from-sky-400 via-sky-200 to-green-100 border-white';
    }
  };

  const advanceDay = () => {
    setDay((prev) => {
      const newDay = prev + 1;
      if (newDay >= MAX_DAYS) {
        endGame();
      }
      return newDay;
    });

    setStats((prev) => {
      let newWater = prev.water;
      let newFertilizer = prev.fertilizer;
      let newHealth = prev.health;
      let newSize = prev.size;
      let newSideShoots = prev.sideShoots;
      
      const isEndGameApproaching = MAX_DAYS - day < 15;

      // å¤©å€™ã«ã‚ˆã‚‹æ°´åˆ†å¤‰åŒ–
      if (weather === 'sunny') newWater -= 5;
      if (weather === 'rainy') newWater += 10;
      if (weather === 'cloudy') newWater -= 2;

      // æˆé•·ã«ã‚ˆã‚‹æ¶ˆè²»
      if (prev.size > 10) newFertilizer -= 2;
      newWater -= prev.size * 0.1;

      // ã‚ãèŠ½ã®ç™ºç”Ÿ
      if (!isEndGameApproaching && day > 25 && Math.random() < 0.08 && prev.sideShoots < 4) {
        newSideShoots += 1;
        setMessage('âš ï¸ ã‚ãèŠ½ãŒä¼¸ã³ã¦ãã¾ã—ãŸï¼æ—©ã‚ã«æ‘˜èŠ¯ã—ã¾ã—ã‚‡ã†ã€‚');
      }

      // ã‚ãèŠ½ãƒšãƒŠãƒ«ãƒ†ã‚£
      if (newSideShoots > 0) {
        newFertilizer -= newSideShoots * 3;
        newSize += 0.1; 
      } else {
        if (newWater > 20 && newWater < 90 && newFertilizer > 20) {
          newSize += 1;
        }
      }

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰å‹•
      if (newWater <= 0 || newWater >= 100) newHealth -= 10;
      if (newFertilizer <= 0) newHealth -= 5;
      if (newHealth < 100 && newWater > 30 && newWater < 80) newHealth += 2;

      // ã‚¹ãƒ­ãƒƒãƒˆï¼ˆèŠ±ãƒ»å®Ÿï¼‰ã®æ›´æ–°
      let newSlots = prev.slots.map(slot => {
        let newState = slot.state;
        let newProgress = slot.progress;
        let newQuality = slot.quality;

        if (newState === 'flower') {
          newProgress += 20; 
          if (newProgress >= 100 || isEndGameApproaching) {
             newState = 'fruit';
             newProgress = 0;
             setMessage('âœ¨ èŠ±ãŒæ•£ã£ã¦ã€å°ã•ãªå®ŸãŒã¤ãã¾ã—ãŸï¼');
          }
        }
        else if (newState === 'fruit') {
           let growthRate = 2;
           if (prev.sideShoots > 0) growthRate *= 0.5;
           if (newHealth < 50) growthRate *= 0.5;

           if (weather === 'sunny') newQuality += 1;
           if (newFertilizer > 50) newQuality += 1;

           if (isEndGameApproaching) {
             growthRate = 15;
           }

           newProgress += growthRate;
           
           if (day === MAX_DAYS - 1) {
             newProgress = 100;
           }
        }
        
        return {
          ...slot,
          state: newState,
          progress: Math.min(100, newProgress),
          quality: newQuality
        };
      });

      // æ–°è¦é–‹èŠ±
      const emptySlots = newSlots.filter(s => s.state === 'empty');
      if (!isEndGameApproaching && day > STAGES.FLOWER.threshold && emptySlots.length > 0) {
        if (Math.random() < 0.2 && newHealth > 60) {
          const targetSlotIndex = Math.floor(Math.random() * emptySlots.length);
          const targetSlotId = emptySlots[targetSlotIndex].id;
          
          newSlots = newSlots.map(s => 
            s.id === targetSlotId 
              ? { ...s, state: 'flower', progress: 0, quality: 50 } 
              : s
          );
          if(Math.random() < 0.5) setMessage('ğŸŒ¼ æ–°ã—ã„èŠ±ãŒå’²ãã¾ã—ãŸï¼');
        }
      }

      return {
        water: Math.max(0, Math.min(100, newWater)),
        fertilizer: Math.max(0, Math.min(100, newFertilizer)),
        health: Math.max(0, Math.min(100, newHealth)),
        size: newSize,
        sideShoots: newSideShoots,
        slots: newSlots
      };
    });
  };

  const startGame = () => {
    setGameState('playing');
    setDay(1);
    setScore(0);
    setHarvestedTomatoes([]);
    setStats({
      water: 60,
      fertilizer: 80,
      health: 100,
      size: 1,
      sideShoots: 0,
      slots: SLOT_POSITIONS.map(p => ({ ...p, state: 'empty', progress: 0, quality: 50 }))
    });
    setMessage('ç¨®ã‚’ã¾ãã¾ã—ãŸï¼ã¾ãšã¯æ°´åˆ‡ã‚Œã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚');
  };

  const endGame = () => {
    setGameState('result');
    clearInterval(timerRef.current);
  };

  const handleWater = () => {
    setStats(prev => ({ ...prev, water: Math.min(100, prev.water + 30) }));
    setMessage('ğŸ’§ æ°´ã‚’ã‚ã’ã¾ã—ãŸã€‚');
  };

  const handleFertilize = () => {
    setStats(prev => ({ ...prev, fertilizer: Math.min(100, prev.fertilizer + 40) }));
    setMessage('ğŸ’Š è‚¥æ–™ã‚’ä¸ãˆã¾ã—ãŸã€‚å®ŸãŒç”˜ããªã‚Šã¾ã™ï¼');
  };

  const handlePrune = () => {
    if (stats.sideShoots > 0) {
      setStats(prev => ({ ...prev, sideShoots: prev.sideShoots - 1 }));
      setMessage('âœ‚ï¸ æ‘˜èŠ¯ã—ã¾ã—ãŸï¼æ „é¤ŠãŒå®Ÿã«é›†ä¸­ã—ã¾ã™ã€‚');
    } else {
      setMessage('ä»Šã¯æ‘˜èŠ¯ã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
    }
  };

  const handleHarvest = (slotId) => {
    const slotIndex = stats.slots.findIndex(s => s.id === slotId);
    if (slotIndex === -1) return;
    
    const slot = stats.slots[slotIndex];
    if (slot.state !== 'fruit') return;

    if (slot.progress < 90) {
      setMessage('ã¾ã é’ã„ã§ã™ï¼èµ¤ããªã‚‹ã¾ã§å¾…ã¡ã¾ã—ã‚‡ã†ã€‚');
      return;
    }

    // é‡ã•ã®è¨ˆç®—
    const weight = Math.floor((100 + (slot.quality / 2)) * (1 + (slot.quality / 200)));
    const sugar = Math.floor(slot.quality / 10);
    const fruitScore = weight * sugar;

    setHarvestedTomatoes(prev => [...prev, { weight, sugar, score: fruitScore }]);
    setScore(prev => prev + fruitScore);
    
    const newSlots = [...stats.slots];
    newSlots[slotIndex] = { ...newSlots[slotIndex], state: 'empty', progress: 0, quality: 50 };
    setStats(prev => ({ ...prev, slots: newSlots }));

    setMessage(`ğŸ… åç©«ã—ã¾ã—ãŸï¼ é‡ã•:${weight}g ç³–åº¦:${sugar}`);
  };

  const getCurrentStage = () => {
    if (day >= STAGES.HARVEST.threshold) return STAGES.HARVEST;
    if (day >= STAGES.FRUIT.threshold) return STAGES.FRUIT;
    if (day >= STAGES.FLOWER.threshold) return STAGES.FLOWER;
    if (day >= STAGES.GROWTH.threshold) return STAGES.GROWTH;
    if (day >= STAGES.SPROUT.threshold) return STAGES.SPROUT;
    return STAGES.SEED;
  };

  const currentStage = getCurrentStage();

  const getStatusColor = (val, type) => {
    if (type === 'water') {
      if (val < 20 || val > 90) return 'bg-red-500';
      if (val < 40 || val > 80) return 'bg-yellow-400';
      return 'bg-blue-500';
    }
    if (val < 30) return 'bg-red-500';
    if (val < 60) return 'bg-yellow-400';
    return 'bg-green-500';
  };

  if (gameState === 'start') {
    return (
      <div className="min-h-screen bg-orange-50 flex flex-col items-center justify-center p-4 font-sans text-gray-800">
        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border-4 border-red-400">
          <div className="mb-4 flex justify-center text-red-500">
            <Trophy size={64} />
          </div>
          <h1 className="text-3xl font-bold mb-4 text-red-600">ãƒˆãƒãƒˆæ ½åŸ¹ãƒã‚¹ã‚¿ãƒ¼</h1>
          <p className="mb-6 text-gray-600">
            ç¨®ã¾ãã‹ã‚‰åç©«ã¾ã§ã®{MAX_DAYS}æ—¥é–“ã§ã€<br/>
            æœ€é«˜ã®ãƒˆãƒãƒˆã‚’è‚²ã¦ã‚ˆã†ï¼
          </p>
          <div className="text-left bg-orange-100 p-4 rounded-lg mb-6 text-sm space-y-2">
            <p>ğŸ’§ <b>æ°´ã‚„ã‚Š</b>: ä¹¾ãã™ããšã€ã‚ã’ã™ããšã€‚</p>
            <p>âœ‚ï¸ <b>æ‘˜èŠ¯</b>: æã®ä»˜ã‘æ ¹ã‹ã‚‰å‡ºã‚‹ä¸è¦ãªè‘‰ã‚’ã‚«ãƒƒãƒˆï¼</p>
            <p>ğŸ… <b>åç©«</b>: å®ŸãŒå¤§ãããªã‚Šèµ¤ããªã£ãŸã‚‰<b>ã‚¯ãƒªãƒƒã‚¯</b>ã—ã¦åç©«ï¼</p>
          </div>
          <button 
            onClick={startGame}
            className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl text-xl transition transform hover:scale-105 shadow-lg"
          >
            æ ½åŸ¹ã‚¹ã‚¿ãƒ¼ãƒˆï¼
          </button>
        </div>
      </div>
    );
  }

  if (gameState === 'result') {
    const totalHarvest = harvestedTomatoes.length;
    let rank = "è¦‹ç¿’ã„è¾²å®¶";
    if (score > 5000) rank = "ãƒˆãƒãƒˆã®ç¥æ§˜";
    else if (score > 3000) rank = "ãƒã‚¤ã‚¹ã‚¿ãƒ¼";
    else if (score > 1000) rank = "ãƒ™ãƒ†ãƒ©ãƒ³è¾²å®¶";

    return (
      <div className="min-h-screen bg-green-50 flex flex-col items-center justify-center p-4 font-sans text-gray-800">
        <div className="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full text-center border-4 border-green-400 flex flex-col max-h-[90vh]">
          <h2 className="text-2xl font-bold mb-2 flex-shrink-0">æ ½åŸ¹çµ‚äº†ï¼</h2>
          <div className="text-6xl mb-2 flex-shrink-0">ğŸ†</div>
          <p className="text-lg text-gray-600 mb-1 flex-shrink-0">ã‚ãªãŸã®ãƒ©ãƒ³ã‚¯</p>
          <p className="text-3xl font-bold text-green-600 mb-4 flex-shrink-0">{rank}</p>
          
          <div className="grid grid-cols-2 gap-4 mb-4 flex-shrink-0">
            <div className="bg-gray-100 p-3 rounded-lg">
              <p className="text-xs text-gray-500">ç·ã‚¹ã‚³ã‚¢</p>
              <p className="text-xl font-bold">{score} pt</p>
            </div>
            <div className="bg-gray-100 p-3 rounded-lg">
              <p className="text-xs text-gray-500">åç©«æ•°</p>
              <p className="text-xl font-bold">{totalHarvest} å€‹</p>
            </div>
          </div>

          <div className="text-left mb-4 flex-1 overflow-y-auto bg-gray-50 p-2 rounded border border-gray-200">
             <h3 className="text-sm font-bold text-gray-600 mb-2 border-b pb-1">åç©«ãƒ¬ãƒãƒ¼ãƒˆ</h3>
             {harvestedTomatoes.length === 0 ? (
               <p className="text-xs text-gray-400 text-center py-4">åç©«ã‚¼ãƒ­ã§ã—ãŸ...</p>
             ) : (
               <table className="w-full text-xs">
                 <thead className="text-gray-500">
                   <tr>
                     <th className="text-left font-normal pb-1">No.</th>
                     <th className="text-right font-normal pb-1">é‡ã•</th>
                     <th className="text-right font-normal pb-1">ç³–åº¦</th>
                     <th className="text-right font-normal pb-1">ã‚¹ã‚³ã‚¢</th>
                   </tr>
                 </thead>
                 <tbody>
                   {harvestedTomatoes.map((t, i) => (
                     <tr key={i} className="border-b border-gray-100 last:border-0">
                       <td className="py-1">{i + 1}</td>
                       <td className="text-right py-1">{t.weight}g</td>
                       <td className="text-right py-1">{t.sugar}</td>
                       <td className="text-right py-1 font-bold">{t.score}</td>
                     </tr>
                   ))}
                 </tbody>
                 <tfoot>
                   <tr className="border-t border-gray-300">
                     <td colSpan={3} className="text-right py-2 font-bold">åˆè¨ˆ:</td>
                     <td className="text-right py-2 font-bold text-orange-600">{score}</td>
                   </tr>
                 </tfoot>
               </table>
             )}
          </div>

          <button 
            onClick={() => setGameState('start')}
            className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl transition flex-shrink-0"
          >
            ã‚‚ã†ä¸€åº¦éŠã¶
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-sky-100 flex flex-col items-center p-2 font-sans select-none overflow-hidden transition-colors duration-1000">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± */}
      <div className="w-full max-w-md bg-white rounded-xl shadow-md p-3 mb-2 flex justify-between items-center z-10">
        <div className="flex items-center gap-2">
          <div className="bg-gray-200 p-2 rounded-full">
            <Timer size={20} className="text-gray-600"/>
          </div>
          <div>
            <p className="text-xs text-gray-500">çµŒéæ—¥æ•°</p>
            <p className="text-lg font-bold leading-none">{day} <span className="text-xs font-normal">/ {MAX_DAYS}æ—¥</span></p>
          </div>
        </div>
        <div className="text-right">
          <p className="text-xs text-gray-500">å¤©æ°—</p>
          <div className="text-2xl leading-none">
            {weather === 'sunny' ? 'â˜€ï¸' : weather === 'rainy' ? 'ğŸŒ§ï¸' : 'â˜ï¸'}
          </div>
        </div>
        <div className="text-right">
          <p className="text-xs text-gray-500">ã‚¹ã‚³ã‚¢</p>
          <p className="text-lg font-bold text-orange-600 leading-none">{score}</p>
        </div>
      </div>

      {/* ãƒ¡ã‚¤ãƒ³ã®æ¤ç‰©è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå¤©æ°—ã«åˆã‚ã›ã¦èƒŒæ™¯å¤‰åŒ–ï¼‰ */}
      <div className={`relative flex-1 w-full max-w-md rounded-2xl shadow-inner border-4 mb-2 overflow-hidden flex flex-col items-center justify-end pb-8 transition-all duration-1000 ${getWeatherBackground()}`}>
        
        {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒˆãƒ¼ã‚¹ãƒˆ */}
        <div className="absolute top-4 left-4 right-4 bg-white/90 backdrop-blur px-4 py-2 rounded-lg shadow text-center text-sm font-bold text-gray-700 animate-pulse z-20">
          {message}
        </div>

        {/* å¤ªé™½/é›¨ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆä½ç½®èª¿æ•´ï¼štop-10 -> top-24ï¼‰ */}
        <div className="absolute top-24 right-10 opacity-50 pointer-events-none z-10">
           {weather === 'sunny' && <Sun size={64} className="text-yellow-400 animate-spin-slow" />}
           {weather === 'rainy' && <div className="text-4xl animate-bounce">ğŸ’§</div>}
        </div>

        {/* æ¤ç‰©ã®æç”» (SVGã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåŒ–) */}
        <div className="w-full h-full absolute bottom-0">
          <TomatoPlantSVG 
            stage={currentStage} 
            size={stats.size} 
            sideShoots={stats.sideShoots}
            slots={stats.slots}
            onHarvest={handleHarvest}
          />
        </div>

        <div className="absolute bottom-2 text-green-900 font-bold opacity-50 pointer-events-none">
           STAGE: {currentStage.name}
        </div>
      </div>

      {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */}
      <div className="w-full max-w-md bg-white rounded-xl shadow p-4 mb-2 grid grid-cols-3 gap-4">
        <div className="flex flex-col gap-1">
          <div className="flex justify-between text-xs text-gray-500">
            <span>æ°´åˆ†</span>
            <span>{Math.round(stats.water)}%</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2.5">
            <div className={`h-2.5 rounded-full transition-all duration-500 ${getStatusColor(stats.water, 'water')}`} style={{ width: `${stats.water}%` }}></div>
          </div>
        </div>
        <div className="flex flex-col gap-1">
          <div className="flex justify-between text-xs text-gray-500">
            <span>è‚¥æ–™</span>
            <span>{Math.round(stats.fertilizer)}%</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2.5">
            <div className={`h-2.5 rounded-full transition-all duration-500 ${getStatusColor(stats.fertilizer, 'fert')}`} style={{ width: `${stats.fertilizer}%` }}></div>
          </div>
        </div>
        <div className="flex flex-col gap-1">
          <div className="flex justify-between text-xs text-gray-500">
            <span>å…ƒæ°—</span>
            <span>{Math.round(stats.health)}%</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2.5">
            <div className={`h-2.5 rounded-full transition-all duration-500 ${getStatusColor(stats.health, 'health')}`} style={{ width: `${stats.health}%` }}></div>
          </div>
        </div>
      </div>

      {/* æ“ä½œãƒœã‚¿ãƒ³ */}
      <div className="w-full max-w-md grid grid-cols-3 gap-2 pb-4">
        <button 
          onClick={handleWater}
          className="flex flex-col items-center justify-center bg-blue-500 active:bg-blue-600 text-white p-3 rounded-xl shadow-lg transition transform active:scale-95"
        >
          <Droplets className="mb-1" />
          <span className="text-sm font-bold">æ°´ã‚„ã‚Š</span>
        </button>

        <button 
          onClick={handleFertilize}
          disabled={day < STAGES.GROWTH.threshold}
          className={`flex flex-col items-center justify-center p-3 rounded-xl shadow-lg transition transform active:scale-95 ${
            day < STAGES.GROWTH.threshold ? 'bg-gray-300 text-gray-500' : 'bg-amber-500 active:bg-amber-600 text-white'
          }`}
        >
          <Shovel className="mb-1" />
          <span className="text-sm font-bold">è¿½è‚¥</span>
        </button>

        <button 
          onClick={handlePrune}
          disabled={day < STAGES.GROWTH.threshold}
          className={`relative flex flex-col items-center justify-center p-3 rounded-xl shadow-lg transition transform active:scale-95 ${
            day < STAGES.GROWTH.threshold ? 'bg-gray-300 text-gray-500' : 'bg-green-600 active:bg-green-700 text-white'
          }`}
        >
          {stats.sideShoots > 0 && (
             <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full animate-bounce">!</span>
          )}
          <Scissors className="mb-1" />
          <span className="text-sm font-bold">æ‘˜èŠ¯</span>
        </button>
      </div>

    </div>
  );
}
